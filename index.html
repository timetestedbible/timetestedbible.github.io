<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Time Tested Bible</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Bible study app with lunar calendar, Strong's concordance, interlinear Hebrew/Greek, word studies, and historical timeline. Track Sabbaths, feast days, and appointed times.">
  <meta name="keywords" content="bible study, biblical calendar, hebrew calendar, strongs concordance, interlinear bible, feast days, sabbath calendar, moon phases, biblical timeline, appointed times, torah portions">
  <meta name="author" content="Time Tested Bible">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://timetested.bible/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://timetested.bible/">
  <meta property="og:title" content="Time Tested Bible">
  <meta property="og:description" content="Bible study app with lunar calendar, Strong's concordance, interlinear Hebrew/Greek, word studies, and historical timeline.">
  <meta property="og:image" content="https://timetested.bible/icons/icon-512.png">
  <meta property="og:site_name" content="Time Tested Bible">
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://timetested.bible/">
  <meta name="twitter:title" content="Time Tested Bible">
  <meta name="twitter:description" content="Bible study app with lunar calendar, Strong's concordance, interlinear Hebrew/Greek, word studies, and historical timeline.">
  <meta name="twitter:image" content="https://timetested.bible/icons/icon-512.png">
  
  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Time Tested Bible",
    "description": "Bible study app with lunar calendar, Strong's concordance, interlinear Hebrew/Greek, word studies, and historical timeline. Track Sabbaths, feast days, and appointed times.",
    "url": "https://timetested.bible/",
    "applicationCategory": "ReferenceApplication",
    "operatingSystem": "Any",
    "browserRequirements": "Requires JavaScript",
    "softwareVersion": "2.0",
    "author": {
      "@type": "Organization",
      "name": "Time Tested Bible",
      "url": "https://timetested.bible"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": "Lunar Calendar, Biblical Timeline, Sabbath Tester, Bible Reader with Strong's Concordance, Priestly Courses, Torah Portions, Date Calculator, World Clock",
    "screenshot": "https://timetested.bible/icons/icon-512.png"
  },
  {
    "@context": "https://schema.org",
    "@type": "Book",
    "name": "A Time Tested Tradition",
    "description": "An exploration of biblical calendar methodology using first-principles physics, astronomical calculations, and Scripture to determine when the day, month, year, and Sabbath begin.",
    "url": "https://timetested.bible/reader/timetested/01_Introduction",
    "author": {
      "@type": "Person",
      "name": "Daniel Larimer"
    },
    "inLanguage": "en",
    "genre": "Religion",
    "about": [
      {"@type": "Thing", "name": "Biblical calendar"},
      {"@type": "Thing", "name": "Lunar Sabbath"},
      {"@type": "Thing", "name": "Biblical chronology"}
    ],
    "isAccessibleForFree": true
  }]
  </script>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a3a5c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Time Tested Bible">
  
  <!-- Favicons -->
  <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Preload critical resources that JS will need after init -->
  <link rel="preload" href="/lib/swisseph/swisseph.wasm" as="fetch" crossorigin>
  <link rel="preload" href="/data/eclipses.json" as="fetch" crossorigin>
  <link rel="preload" href="/lib/swisseph/swisseph-browser.js" as="script" crossorigin>
  
  <!-- Theme tokens MUST load first (defines all color variables for both themes) -->
  <link rel="stylesheet" href="/assets/css/theme-tokens.css">
  
  <!-- Prevent flash-of-wrong-theme: apply theme before first paint -->
  <script>
    (function() {
      var pref = null;
      try { pref = localStorage.getItem('userThemePreference'); } catch(e) {}
      // Default to 'auto' for new users
      if (!pref) pref = 'auto';
      var theme;
      if (pref === 'auto') {
        // OS preference first, then time-of-day fallback
        var mq = window.matchMedia('(prefers-color-scheme: light)');
        var mqDark = window.matchMedia('(prefers-color-scheme: dark)');
        if (mq.matches) {
          theme = 'light';
        } else if (mqDark.matches) {
          theme = 'dark';
        } else {
          // No OS preference â€” use time of day (dark 8pmâ€“6am)
          var hour = new Date().getHours();
          theme = (hour >= 6 && hour < 20) ? 'light' : 'dark';
        }
      } else {
        theme = pref;
      }
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.classList.add('no-theme-transition');
      // Update PWA theme-color meta for status bar
      var meta = document.querySelector('meta[name="theme-color"]');
      if (meta) meta.content = theme === 'light' ? '#f5f0e8' : '#1a3a5c';
    })();
  </script>
  
  <!-- Stylesheets (cache busting via SW cache name keyed to APP_VERSION) -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/components/world-map.css">
  <link rel="stylesheet" href="/components/dateline-map.css">
  <link rel="stylesheet" href="/assets/css/bible-styles.css">
  <link rel="stylesheet" href="/assets/css/tutorial.css">
  <link rel="stylesheet" href="/assets/css/methodology.css">
  <link rel="stylesheet" href="/assets/css/settings.css">
  <link rel="stylesheet" href="/assets/css/symbols.css">
  <link rel="stylesheet" href="/assets/css/reader.css">
  <link rel="stylesheet" href="/assets/css/components.css">
  <link rel="stylesheet" href="/assets/css/sabbath-tester.css">
  <link rel="stylesheet" href="/assets/css/blog.css">
  
  <!-- CRITICAL MOBILE FIX: Inline to bypass cache issues and body class dependencies -->
  <style>
    @media (max-width: 768px) {
      /* â•â•â• BIBLE / READER SUB-PAGES (not landing) â•â•â•
         Use BODY SCROLL â€” same as the reader landing page.
         iOS Safari extends body-scrolled content behind the bottom bar;
         contained scroll (overflow/fixed) does not. */
      body.view-bible,
      body.view-reader:not(.reader-landing) {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      body.view-bible .app-container,
      body.view-reader:not(.reader-landing) .app-container {
        flex: none !important;
        height: auto !important;
      }
      body.view-bible .main-layout,
      body.view-reader:not(.reader-landing) .main-layout {
        height: auto !important;
        overflow: visible !important;
      }
      body.view-bible #content-area,
      body.view-reader:not(.reader-landing) #content-area {
        height: auto !important;
        overflow: visible !important;
        padding: 0 !important;
      }
      
      /* Page flows in document â€” no fixed/absolute positioning */
      body.view-bible #bible-explorer-page,
      body.view-reader:not(.reader-landing) #bible-explorer-page {
        position: relative !important;
        top: 0 !important;
        height: auto !important;
        display: flex !important;
        flex-direction: column !important;
        margin: 0 !important;
        padding: 0 !important;
        background: var(--surface-raised, #0d2840) !important;
      }
      
      /* Text area: NO contained scroll â€” body handles scrolling */
      body.view-bible .bible-explorer-text,
      body.view-reader:not(.reader-landing) .bible-explorer-text {
        overflow: visible !important;
        height: auto !important;
        flex: none !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      /* Body and content wrapper: no overflow clipping */
      body.view-bible .bible-explorer-body,
      body.view-reader:not(.reader-landing) .bible-explorer-body {
        overflow: visible !important;
        height: auto !important;
        flex: none !important;
      }
      body.view-bible .bible-content-wrapper,
      body.view-reader:not(.reader-landing) .bible-content-wrapper {
        overflow: visible !important;
        height: auto !important;
        flex: none !important;
      }
      
      .research-panel:not(.open) {
        position: absolute !important;
        width: 0 !important;
        min-width: 0 !important;
        overflow: hidden !important;
        pointer-events: none !important;
        visibility: hidden !important;
      }
    }
  </style>
</head>
<body>
  <!-- Remove no-transition class after first paint to enable smooth theme toggling -->
  <script>requestAnimationFrame(function(){ document.documentElement.classList.remove('no-theme-transition'); });</script>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- TOP NAVIGATION -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header id="top-nav" class="top-nav">
    <div class="top-nav-left">
      <!-- Logo / Brand -->
      <div class="brand" onclick="AppStore.dispatch({type:'SET_VIEW',view:'tutorial'})">
        <span class="brand-icon">ğŸŒ•</span>
        <div class="brand-text">
          <div class="brand-title">Time Tested Bible</div>
        </div>
      </div>
    </div>
    
    <!-- Desktop Navigation Links (hidden on mobile) -->
    <nav class="top-nav-links">
      <!-- Bible Study dropdown -->
      <div class="nav-dropdown" id="bible-study-dropdown">
        <button class="nav-link nav-dropdown-trigger" onclick="Layout.toggleDropdown('bible-study-dropdown')">
          Bible Study <span class="nav-dropdown-arrow">â–¾</span>
        </button>
        <div class="nav-dropdown-menu">
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'bible'}})">
            <span class="nav-dropdown-icon">ğŸ“–</span> Study Bible
          </button>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'symbols'}})">
            <span class="nav-dropdown-icon">ğŸ”£</span> Symbol Studies
          </button>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'verse-studies'}})">
            <span class="nav-dropdown-icon">ğŸ“œ</span> Verse Studies
          </button>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'numbers'}})">
            <span class="nav-dropdown-icon">ğŸ”¢</span> Number Studies
          </button>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'words'}})">
            <span class="nav-dropdown-icon">ğŸ“</span> Word Studies
          </button>
          <div class="nav-dropdown-divider"></div>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'philo'}})">
            <span class="nav-dropdown-icon">ğŸ“š</span> Philo
          </button>
          <button class="nav-dropdown-item" onclick="Layout.closeDropdown(); AppStore.dispatch({type:'SET_VIEW',view:'reader',params:{contentType:'josephus'}})">
            <span class="nav-dropdown-icon">ğŸ“š</span> Josephus
          </button>
        </div>
      </div>
      
      <button class="nav-link" onclick="AppStore.dispatch({type:'SET_VIEW',view:'timeline'})">Timeline</button>
      <button class="nav-link" onclick="AppStore.dispatchBatch([{type:'GO_TO_TODAY'},{type:'SET_VIEW',view:'calendar'}])">Calendar</button>
      <button class="nav-link" onclick="AppStore.dispatch({type:'SET_VIEW',view:'blog'})">Blog</button>
    </nav>
    
    <div class="top-nav-right">
      <!-- Global Search -->
      <div id="global-search-container" class="global-search">
        <input type="text" id="global-search-input" 
               placeholder="Search..." 
               autocomplete="off"
               onkeydown="if(event.key==='Enter') { GlobalSearch.hideHints(); GlobalSearch.search(this.value); }"
               oninput="GlobalSearch.onInput(this.value)"
               onfocus="GlobalSearch.onFocus()"
               onblur="GlobalSearch.onBlur(event)"
               ondblclick="this.select()">
        <button class="global-search-submit" onclick="GlobalSearch.hideHints(); GlobalSearch.search(document.getElementById('global-search-input').value);" title="Search">ğŸ”</button>
        <button class="global-search-btn" onclick="GlobalSearch.toggle()" title="Search">ğŸ”</button>
        <button class="global-search-close" onclick="GlobalSearch.close()" title="Close search">âœ•</button>
        <div id="search-hints" class="search-hints" style="display: none;" onmousedown="event.preventDefault()">
          <div class="search-hints-title">Try searching for...</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('Genesis 1:1')"><span class="search-hint-type">Verse</span> Genesis 1:1</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('Solomon Temple')"><span class="search-hint-type">Event</span> Solomon Temple</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('H430')"><span class="search-hint-type">Strongs</span> H430</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('May 14, 1948')"><span class="search-hint-type">Date</span> May 14, 1948</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('Nisan 14, 32 AD')"><span class="search-hint-type">Lunar</span> Nisan 14, 32 AD</div>
          <div class="search-hint-item" onclick="GlobalSearch.useHint('Antiquities 18.2.2')"><span class="search-hint-type">Classics</span> Antiquities 18.2.2</div>
          <div class="search-hint-footer" onclick="GlobalSearch.hideHints(); AppStore.dispatch({type:'SET_VIEW', view:'help'}); setTimeout(() => HelpView.scrollToSection('search-section'), 300);">Learn more about searching</div>
        </div>
      </div>
      
      <!-- Navigation History Buttons - only visible in PWA mode -->
      <div class="nav-history-buttons">
        <button id="nav-back-btn" class="nav-btn" onclick="history.back()" title="Go back"><span class="icon icon-chevron-left"></span></button>
        <button id="nav-forward-btn" class="nav-btn" onclick="history.forward()" title="Go forward"><span class="icon icon-chevron-right"></span></button>
      </div>
      
      <!-- Settings gear (desktop only) -->
      <button class="nav-settings-btn" onclick="AppStore.dispatch({type:'SET_VIEW',view:'settings'})" title="Settings">âš™ï¸</button>
      
      <!-- Hamburger Menu Button -->
      <button id="hamburger-btn" class="hamburger-btn" aria-label="Open menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
    </div>
    
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- GLOBAL SEARCH RESULTS (inside header so it stays with nav on scroll) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="global-search-results" class="global-search-results">
      <div id="search-filter-bar" class="search-filter-bar">
        <button class="search-filter-btn active" data-filter="events" onclick="GlobalSearch.toggleFilter('events')">Events</button>
        <button class="search-filter-btn active" data-filter="bible" onclick="GlobalSearch.toggleFilter('bible')">Bible</button>
        <button class="search-filter-btn active" data-filter="studies" onclick="GlobalSearch.toggleFilter('studies')">Studies</button>
        <button class="search-filter-btn active" data-filter="strongs" onclick="GlobalSearch.toggleFilter('strongs')">Strongs</button>
      </div>
      <div class="search-results-content" id="search-results-content">
        <!-- Results rendered here -->
      </div>
      <div class="search-results-handle" id="search-results-handle" title="Drag to resize">
        <div class="handle-bar"></div>
      </div>
    </div>
    
    <!-- Sub-nav bar: global slot for view-specific controls (book/chapter selectors, etc.) -->
    <div id="sub-nav-bar" class="sub-nav-bar"></div>
  </header>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- MAIN LAYOUT -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app-container" class="app-container">
    
    <!-- Menu Overlay (mobile) -->
    <div id="menu-overlay" class="menu-overlay"></div>
    
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- 3-COLUMN LAYOUT -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="main-layout">
      <!-- Left Panel (Feasts - inline on desktop, overlay on mobile) -->
      <aside id="left-panel" class="side-panel left-panel collapsed">
        <div class="panel-header">
          <span class="panel-title">ğŸ‰ Feasts</span>
          <div class="panel-header-actions">
            <button class="panel-export-btn" onclick="CalendarExport.showExportModal()" title="Export Calendar">ğŸ“¤</button>
            <button class="panel-close" data-panel="left">âœ•</button>
          </div>
        </div>
        <div class="panel-content" id="left-panel-content">
          <!-- Feast list rendered by CalendarView -->
        </div>
      </aside>
      
      <!-- Priestly Panel (independent slideout) -->
      <aside id="priestly-panel" class="side-panel priestly-panel collapsed">
        <div class="panel-header">
          <span class="panel-title">ğŸ‘¨â€ğŸ¦³ Priestly Courses</span>
          <button class="panel-close" data-panel="priestly">âœ•</button>
        </div>
        <div class="panel-content" id="priestly-panel-content">
          <!-- Priestly cycle list rendered by CalendarView -->
        </div>
      </aside>
      
      <!-- Center Content Area (expands to fill) -->
      <main id="content-area" class="content-area">
        <!-- Content rendered by ContentManager -->
        <div class="loading">Loading...</div>
        <noscript>
          <div style="padding: 20px; max-width: 800px; margin: 0 auto; line-height: 1.6;">
            <h1>Time Tested Bible</h1>
            <p>A comprehensive biblical calendar application that uses precise astronomical calculations to compute lunar Sabbaths, feast days, priestly courses, and historical biblical events. Compare multiple calendar theories against Scripture and astronomical data.</p>

            <h2>Features</h2>
            <ul>
              <li><strong>Lunar Calendar</strong> â€” Full Moon, Dark Moon, and Crescent Moon month-start options with configurable day-start (morning or evening) and year-start rules</li>
              <li><strong>Biblical Timeline</strong> â€” Interactive timeline spanning 4050 BC to 3500 AD with over 500 historical and prophetic events</li>
              <li><strong>Sabbath Tester</strong> â€” Tests calendar configurations against 7 biblical events where specific weekdays are mentioned in Scripture</li>
              <li><strong>Bible Reader</strong> â€” KJV, ASV, and Septuagint translations with Strong's Hebrew/Greek dictionaries and interlinear display</li>
              <li><strong>Priestly Courses</strong> â€” 24 Mishmarot divisions calculated from Temple dedication and destruction anchors</li>
              <li><strong>Torah Portions</strong> â€” Weekly Torah readings for both Lunar Sabbath and Saturday Sabbath observance</li>
              <li><strong>Date Calculator</strong> â€” Add/subtract years, months, weeks, and days in both lunar and Gregorian modes</li>
              <li><strong>World Clock</strong> â€” Compare the same moment across different calendar profiles and locations</li>
            </ul>

            <h2>Book: A Time Tested Tradition</h2>
            <p>This app is the interactive companion to the book exploring biblical calendar methodology. Chapters include:</p>
            <ul>
              <li>When Does the Day Start? â€” Evidence for morning vs evening</li>
              <li>When Does the Month Start? â€” Full moon, dark moon, or crescent?</li>
              <li>When is the Sabbath? â€” The case for Lunar Sabbath from Scripture, history, and physics</li>
              <li>32 AD Resurrection â€” Multiple independent proofs for the crucifixion year</li>
              <li>Passion Week â€” 3 Days and 3 Nights reconciled</li>
              <li>Appointed Times â€” Feast days and their prophetic significance</li>
            </ul>

            <h2>Calendar Profiles</h2>
            <p>Compare five preset calendar configurations or create your own:</p>
            <ul>
              <li><strong>Time-Tested</strong> â€” Full Moon, Morning start, Equinox year, Lunar Sabbath</li>
              <li><strong>Ancient Traditional</strong> â€” Crescent Moon, Evening start, Saturday Sabbath</li>
              <li><strong>119 Ministries</strong> â€” Dark Moon, Evening start, Saturday Sabbath</li>
              <li><strong>Creator's Calendar</strong> â€” Full Moon, Morning start, Virgo year rule</li>
              <li><strong>Traditional Lunar Sabbath</strong> â€” Crescent Moon, Evening start, Lunar Sabbath</li>
            </ul>

            <p>This application requires JavaScript to run. Please enable JavaScript in your browser to use the interactive calendar, timeline, and Bible reader.</p>
          </div>
        </noscript>
      </main>
    </div>
    
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- SIDEBAR MENU (hamburger slide-in, all screen sizes) -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <aside id="sidebar-menu" class="sidebar-menu">
      <div class="sidebar-header">
        <span class="sidebar-header-title">Menu</span>
        <button class="sidebar-close-btn" onclick="AppStore.dispatch({type:'CLOSE_MENU'})">âœ•</button>
      </div>
      
      <nav class="sidebar-nav">
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'GO_TO_TODAY'},{type:'SET_VIEW',view:'calendar'}])">
          <span class="menu-icon">ğŸ“…</span>
          <span class="menu-label">Calendar</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'timeline'}])">
          <img src="/assets/img/timeline_icon.png" alt="" class="menu-icon-img">
          <span class="menu-label">Timeline</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'sabbath-tester'}])">
          <span class="menu-icon">ğŸ”¬</span>
          <span class="menu-label">Sabbath Tester</span>
        </button>
        
        <div class="menu-divider"></div>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'bible'}}])">
          <span class="menu-icon">ğŸ“–</span>
          <span class="menu-label">Study Bible</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'symbols'}}])">
          <span class="menu-icon">ğŸ”£</span>
          <span class="menu-label">Symbol Studies</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'verse-studies'}}])">
          <span class="menu-icon">ğŸ“œ</span>
          <span class="menu-label">Verse Studies</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'numbers'}}])">
          <span class="menu-icon">ğŸ”¢</span>
          <span class="menu-label">Number Studies</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'words'}}])">
          <span class="menu-icon">ğŸ“</span>
          <span class="menu-label">Word Studies</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'philo'}}])">
          <span class="menu-icon">ğŸ“š</span>
          <span class="menu-label">Philo</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'josephus'}}])">
          <span class="menu-icon">ğŸ“š</span>
          <span class="menu-label">Josephus</span>
        </button>
        
        <div class="menu-divider"></div>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'blog'}])">
          <span class="menu-icon">ğŸ“°</span>
          <span class="menu-label">Blog (What's New)</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'tutorial'}])">
          <span class="menu-icon">ğŸ§­</span>
          <span class="menu-label">Explore</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'settings'}])">
          <span class="menu-icon">âš™ï¸</span>
          <span class="menu-label">Settings</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'methodology'}])">
          <span class="menu-icon">ğŸ“œ</span>
          <span class="menu-label">How We Study</span>
        </button>
        
        <button class="menu-item" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'help'}])">
          <span class="menu-icon">â“</span>
          <span class="menu-label">Help</span>
        </button>
        
        <div class="menu-divider"></div>
        
        <div class="menu-book-promo">
          <button class="menu-book-link" onclick="AppStore.dispatchBatch([{type:'CLOSE_MENU'},{type:'SET_VIEW',view:'reader',params:{contentType:'timetested'}}])">
            <img src="/assets/img/TimeTestedBookFront.jpg" alt="Time-Tested Tradition Book Cover" class="menu-book-cover">
          </button>
          <a class="menu-book-download" href="/media/time-tested-tradition.pdf" download onclick="trackBookDownload()">
            <span class="icon">ğŸ“¥</span>
            <span>Download PDF</span>
          </a>
        </div>
        
        <button class="menu-item" id="install-app-btn" style="display: none;" onclick="handleInstallClick()">
          <span class="menu-icon">ğŸ“²</span>
          <span class="menu-label">Install App</span>
        </button>
        
      </nav>
    </aside>
  </div>
  
  <!-- iOS Install Instructions Modal -->
  <div id="ios-install-overlay" class="ios-install-overlay" onclick="closeIOSInstallModal(event)">
    <div class="ios-install-modal" onclick="event.stopPropagation()">
      <button class="ios-install-close" onclick="closeIOSInstallModal()">âœ•</button>
      <div class="ios-install-header">
        <span class="ios-install-icon">ğŸ“²</span>
        <h3>Install Time Tested Bible</h3>
      </div>
      <p class="ios-install-intro">Add this app to your home screen for quick access and an app-like experience.</p>
      <div class="ios-install-steps">
        <div class="ios-install-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <p>Tap the <strong>Share</strong> button <span class="ios-share-icon">â¬†ï¸</span> in Safari's toolbar</p>
          </div>
        </div>
        <div class="ios-install-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <p>Scroll down and tap <strong>"Add to Home Screen"</strong></p>
          </div>
        </div>
        <div class="ios-install-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <p>Tap <strong>"Add"</strong> in the top right corner</p>
          </div>
        </div>
      </div>
      <button class="ios-install-done-btn" onclick="closeIOSInstallModal()">Got it!</button>
    </div>
  </div>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- MODALS / OVERLAYS -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <!-- Profile Picker Popup -->
  <div id="profile-picker" class="profile-picker" style="display: none;">
    <div class="profile-picker-header">
      <h3>Select Profile</h3>
      <button onclick="AppStore.dispatch({type:'SET_VIEW',view:'settings'}); AppStore.dispatch({type:'CLOSE_PROFILE_PICKER'});">âš™ï¸</button>
    </div>
    <div id="profile-picker-list" class="profile-picker-list">
      <!-- Populated by JavaScript -->
    </div>
  </div>
  
  <!-- Strongs Panel (slide-in from right) -->
  <div id="strongs-panel" class="strongs-panel" style="display: none;">
    <div class="strongs-header">
      <button class="strongs-back" onclick="StrongsPanel.back()"><span class="icon icon-chevron-left"></span></button>
      <h3 id="strongs-title">Strong's</h3>
      <button class="strongs-close" onclick="AppStore.dispatch({type:'CLOSE_STRONGS'})">âœ•</button>
    </div>
    <div id="strongs-content" class="strongs-content">
      <!-- Populated by JavaScript -->
    </div>
  </div>
  
  <!-- Bible tooltips & popups: fixed overlay so they always paint on top -->
  <div id="bible-tooltip-portal" class="bible-tooltip-portal" aria-hidden="true"></div>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SCRIPTS -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  
  <!-- App version (single source of truth for all cache busting) -->
  <script src="/version.js"></script>
  
  <!-- External Libraries (bundled locally) -->
  <script src="/lib/astronomy.browser.min.js"></script>
  <script src="/lib/tz.min.js"></script>
  <script src="/lib/marked.min.js"></script>
  
  <!-- Timezone lookup utility -->
  <script src="/timezone-utils.js"></script>
  
  <!-- Astronomy Engine Abstraction (loads Swiss Ephemeris, NASA Eclipse data) -->
  <script src="/astronomy-engine-abstraction.js"></script>
  <script src="/astronomy-utils.js"></script>
  <script src="/lunar-calendar-engine.js"></script>
  <!-- Hebcal (optional): run scripts/fetch-hebcal.sh to download the bundle -->
  <script src="/lib/hebcal/hebcal-core.min.js"></script>
  <script src="/lib/hebcal/hebcal-loader.js"></script>
  <script src="/hebcal-adapter.js"></script>
  <script src="/jubilee-cycle.js"></script>
  <script src="/feasts.js"></script>
  <script src="/bible-events-loader.js"></script>
  <script src="/torah-portions.js"></script>
  <script src="/priestly-divisions.js"></script>
  
  <!-- Year utilities (BC/AD conversion) -->
  <script src="/year-utils.js"></script>
  
  <!-- Core (cache-bust with version) -->
  <script src="/app-store.js"></script>
  <script src="/url-router.js"></script>
  <script src="/layout.js"></script>
  <script src="/content-manager.js"></script>
  
  <!-- Components -->
  <script src="/components/world-map.js"></script>
  <script src="/components/dateline-map.js"></script>
  
  <!-- Calendar Export -->
  <script src="/calendar-export.js"></script>
  
  <!-- Global Search -->
  <script src="/global-search.js"></script>
  
  <!-- Views -->
  <script src="/views/calendar-view.js"></script>
  
  <!-- Bible Reader and Strong's Dictionaries -->
  <script src="/strongs-hebrew-dictionary.js"></script>
  <script src="/strongs-greek-dictionary.js"></script>
  <script src="/symbol-dictionary.js"></script>
  <script src="/word-study-dictionary.js"></script>
  <script src="/book-scripture-index.js"></script>
  <script src="/cross-references.js"></script>
  <script src="/verse-event-links.js"></script>
  <script src="/bible.js"></script>
  <script src="/classics.js"></script>
  <script src="/morphology-decoder.js"></script>
  <script src="/morphhb-gloss.js"></script>
  <script src="/translation-patches.js"></script>
  <script src="/bible-reader.js"></script>
  <script src="/views/bible-view.js"></script>
  <script src="/views/symbols-view.js"></script>
  <script src="/timetested-chapters.js"></script>
  <script src="/views/reader-view.js"></script>
  
  <!-- Timeline and Historical Events -->
  <script src="/event-resolver.js"></script>
  <script src="/resolved-events-cache.js"></script>
  <script src="/biblical-timeline.js?v=34"></script>
  <script src="/views/timeline-view.js"></script>
  
  <!-- Day Detail and World Clock -->
  <script src="/day-detail.js"></script>
  <script src="/world-clock.js"></script>
  <script src="/views/book-view.js"></script>
  <script src="/views/tutorial-view.js"></script>
  <script src="/views/help-view.js"></script>
  <script src="/views/methodology-view.js"></script>
  <script src="/views/priestly-view.js"></script>
  <script src="/views/sabbath-tester-view.js"></script>
  <script src="/views/blog-view.js"></script>
  <script src="/views/settings-view.js"></script>
  
  <!-- Initialize App -->
  <script>
    // FEASTS is now loaded from /feasts.js
    
    // Global state object - syncs with AppStore for compatibility with ported modules
    window.state = {
      lat: 31.7683,
      lon: 35.2137,
      year: new Date().getFullYear(),
      moonPhase: 'full',
      dayStartTime: 'morning',
      dayStartAngle: 12,
      yearStartRule: 'equinox',
      crescentThreshold: 18,
      sabbathMode: 'lunar',
      selectedProfile: 'timeTested',
      lunarMonths: [],
      currentMonthIndex: 0,
      highlightedLunarDay: 1
    };
    
    // Sync global state from AppStore (for ported modules)
    function syncGlobalState() {
      if (typeof AppStore === 'undefined') return;
      const s = AppStore.getState();
      const d = AppStore.getDerived();
      const profile = window.PROFILES?.[s.context.profileId] || {};
      
      window.state.lat = s.context.location.lat;
      window.state.lon = s.context.location.lon;
      window.state.year = d.year;
      window.state.moonPhase = profile.moonPhase || 'full';
      window.state.dayStartTime = profile.dayStartTime || 'morning';
      window.state.dayStartAngle = profile.dayStartAngle || 12;
      window.state.yearStartRule = profile.yearStartRule || 'equinox';
      window.state.crescentThreshold = profile.crescentThreshold || 18;
      window.state.sabbathMode = profile.sabbathMode || 'lunar';
      window.state.selectedProfile = s.context.profileId;
      window.state.lunarMonths = d.lunarMonths || [];
      window.state.currentMonthIndex = d.currentMonthIndex || 0;
      window.state.highlightedLunarDay = d.currentLunarDay || 1;
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[App] Starting initialization...');
      
      // Profile definitions (needed for AppStore)
      const defaultProfiles = {
        timeTested: {
          name: 'Time-Tested',
          icon: 'ğŸŒ•',
          moonPhase: 'full',
          dayStartTime: 'morning',
          dayStartAngle: 12,
          yearStartRule: 'equinox',
          crescentThreshold: 18,
          sabbathMode: 'lunar'
        },
        ancientTraditional: {
          name: 'Ancient Traditional',
          icon: 'ğŸŒ’',
          moonPhase: 'crescent',
          dayStartTime: 'evening',
          dayStartAngle: 0,
          yearStartRule: '14daysBefore',
          crescentThreshold: 18,
          sabbathMode: 'saturday'
        },
        ministries119: {
          name: 'Rabbinic Saturday',
          icon: 'ğŸŒ‘',
          moonPhase: 'dark',
          dayStartTime: 'evening',
          dayStartAngle: 0,
          yearStartRule: '14daysBefore',
          crescentThreshold: 18,
          sabbathMode: 'saturday'
        },
        ministries119Equinox: {
          name: '119 Ministries',
          icon: 'ğŸŒ‘',
          moonPhase: 'dark',
          dayStartTime: 'evening',
          dayStartAngle: 18,
          yearStartRule: '1dayBefore',
          crescentThreshold: 18,
          sabbathMode: 'saturday'
        },
        creatorsCalendar: {
          name: "Creator's Calendar",
          icon: 'ğŸŒ•',
          moonPhase: 'full',
          dayStartTime: 'morning',
          dayStartAngle: 0,
          yearStartRule: 'virgoFeet',
          crescentThreshold: 18,
          sabbathMode: 'lunar'
        },
        traditionalLunar: {
          name: 'Traditional Lunar Sabbath',
          icon: 'ğŸŒ’',
          moonPhase: 'crescent',
          dayStartTime: 'evening',
          dayStartAngle: 0,
          yearStartRule: 'equinox',
          crescentThreshold: 18,
          sabbathMode: 'lunar'
        },
        traditionalSaturday: {
          name: 'Traditional Saturday',
          icon: 'ğŸŒ’',
          moonPhase: 'crescent',
          dayStartTime: 'evening',
          dayStartAngle: 0,
          yearStartRule: 'equinox',
          crescentThreshold: 18,
          sabbathMode: 'saturday'
        },
        modernJewish: {
          name: 'Modern Jewish',
          icon: 'ğŸ•',
          moonPhase: 'dark',
          dayStartTime: 'evening',
          dayStartAngle: 0,
          yearStartRule: 'equinox',
          crescentThreshold: 18,
          sabbathMode: 'saturday',
          calendarBackend: 'hebcal'
        }
      };
      
      window.PROFILES = defaultProfiles;
      
      // Initialize URL router first (synchronous, fast)
      URLRouter.init();
      
      // Start astronomy engine loading in background (don't block UI)
      const astroEnginePromise = (async () => {
        if (typeof initializeAstroEngine === 'function') {
          console.log('[App] Loading astronomy engine in background...');
          await initializeAstroEngine();
          console.log('[App] Astronomy engine ready:', getAstroEngine().name);
          return getAstroEngine();
        }
        return null;
      })();
      
      // Get the astronomy engine (may be null if still loading)
      const astroEngine = typeof getAstroEngine === 'function' ? getAstroEngine() : null;
      
      // Initialize AppStore with profiles (will use fallback if engine not ready)
      // Must be before Layout.init() since Layout subscribes to AppStore
      AppStore.init({
        profiles: defaultProfiles,
        astroEngine: astroEngine
      });
      
      // Initialize layout (subscribes to AppStore for menu state)
      Layout.init();
      
      // Initialize content manager (subscribes to AppStore for view changes)
      ContentManager.init();
      
      // Initialize translation patches (async, non-blocking)
      if (typeof TranslationPatches !== 'undefined') {
        TranslationPatches.init();
      }
      
      // Load supplementary data in parallel (don't block initial render)
      // Note: loadBibleEvents is called AFTER timeline pre-resolution (needs resolved events)
      const dataPromises = [];
      if (typeof loadTorahPortions === 'function') {
        dataPromises.push(loadTorahPortions());
      }
      if (typeof loadPriestlyDivisions === 'function') {
        dataPromises.push(loadPriestlyDivisions());
      }
      
      // Wait for all data to load, then refresh calendar with complete data
      Promise.all([astroEnginePromise, ...dataPromises]).then(() => {
        console.log('[App] All data loaded, refreshing calendar...');
        // Update AppStore with the now-ready astronomy engine
        const readyEngine = typeof getAstroEngine === 'function' ? getAstroEngine() : null;
        if (readyEngine) {
          AppStore.dispatch({ type: 'SET_ASTRO_ENGINE', payload: readyEngine });
        }
        AppStore.dispatch({ type: 'REFRESH' });
        
        // Load resolved events + bible events.
        // If cached (normal case): runs instantly, no delay.
        // If not cached (first visit): defers to idle callback to avoid blocking UI.
        const loadEventsAndPopulate = async () => {
          if (typeof ResolvedEventsCache === 'undefined') return;
          const appState = AppStore.getState();
          const profileId = appState.context?.profileId || 'timeTested';
          const profileObj = window.PROFILES?.[profileId] || {};
          const profile = {
            moonPhase: profileObj.moonPhase || 'full',
            dayStartTime: profileObj.dayStartTime || 'morning',
            dayStartAngle: profileObj.dayStartAngle ?? 12,
            yearStartRule: profileObj.yearStartRule || 'equinox',
            crescentThreshold: profileObj.crescentThreshold ?? 18,
            lat: appState.context?.location?.lat || 31.7683,
            lon: appState.context?.location?.lon || 35.2137,
            amEpoch: -4000
          };
          
          await ResolvedEventsCache.preload(profile);
          
          if (typeof loadBibleEvents === 'function') {
            await loadBibleEvents();
            AppStore.dispatch({ type: 'REPOPULATE_DAY_DATA' });
          }
        };
        
        // Try synchronous cache check â€” if cached, load immediately
        if (typeof ResolvedEventsCache !== 'undefined') {
          const appState = AppStore.getState();
          const profileId = appState.context?.profileId || 'timeTested';
          const profileObj = window.PROFILES?.[profileId] || {};
          const profile = {
            moonPhase: profileObj.moonPhase || 'full',
            dayStartTime: profileObj.dayStartTime || 'morning',
            dayStartAngle: profileObj.dayStartAngle ?? 12,
            yearStartRule: profileObj.yearStartRule || 'equinox',
            crescentThreshold: profileObj.crescentThreshold ?? 18,
            lat: appState.context?.location?.lat || 31.7683,
            lon: appState.context?.location?.lon || 35.2137,
            amEpoch: -4000
          };
          
          const hasSearchQuery = new URLSearchParams(window.location.search).has('q');
          if (ResolvedEventsCache.isCached(profile) || hasSearchQuery) {
            // Cached or search query present â€” load immediately (search needs timeline data)
            console.log('[App] Resolved events:', ResolvedEventsCache.isCached(profile) ? 'cached' : 'search query present', 'â€” loading immediately');
            loadEventsAndPopulate();
          } else {
            // Not cached â€” defer to avoid blocking initial render
            console.log('[App] Resolved events not cached â€” deferring to idle callback');
            const schedulePreResolution = window.requestIdleCallback 
              ? (cb) => window.requestIdleCallback(cb, { timeout: 5000 })
              : (cb) => setTimeout(cb, 2000);
            schedulePreResolution(loadEventsAndPopulate);
          }
        }
      });
      
      // Set up panel toggle handlers
      document.querySelectorAll('.panel-close').forEach(btn => {
        btn.addEventListener('click', () => {
          const panelId = btn.dataset.panel;
          if (panelId === 'left') {
            AppStore.dispatch({ type: 'CLOSE_FEASTS_PANEL' });
          } else if (panelId === 'priestly') {
            AppStore.dispatch({ type: 'CLOSE_PRIESTLY_PANEL' });
          }
        });
      });
      
      // Subscribe to panel state changes (sync DOM with state)
      AppStore.subscribe((state) => {
        if (typeof CalendarView !== 'undefined' && CalendarView.syncPanelState) {
          CalendarView.syncPanelState(state);
        }
      });
      
      // Register views
      if (typeof CalendarView !== 'undefined') ContentManager.registerView('calendar', CalendarView);
      if (typeof BibleView !== 'undefined') ContentManager.registerView('bible', BibleView);
      if (typeof TimelineView !== 'undefined') ContentManager.registerView('timeline', TimelineView);
      if (typeof BookView !== 'undefined') ContentManager.registerView('book', BookView);
      if (typeof TutorialView !== 'undefined') ContentManager.registerView('tutorial', TutorialView);
      if (typeof HelpView !== 'undefined') ContentManager.registerView('help', HelpView);
      if (typeof MethodologyView !== 'undefined') ContentManager.registerView('methodology', MethodologyView);
      if (typeof PriestlyView !== 'undefined') ContentManager.registerView('priestly', PriestlyView);
      if (typeof SabbathTesterView !== 'undefined') ContentManager.registerView('sabbath-tester', SabbathTesterView);
      if (typeof BlogView !== 'undefined') ContentManager.registerView('blog', BlogView);
      if (typeof SettingsView !== 'undefined') ContentManager.registerView('settings', SettingsView);
      // EventsView removed â€” was unreachable (no menu entry)
      
      // GitHub Pages SPA redirect: if 404.html stored a path, restore it
      const spaRedirect = sessionStorage.getItem('spa-redirect');
      if (spaRedirect) {
        sessionStorage.removeItem('spa-redirect');
        history.replaceState({}, '', spaRedirect);
      }
      
      // Load initial state from URL
      AppStore.dispatch({ type: 'INIT_FROM_URL', url: window.location });
      
      // Add initial URL to navigation history
      AppStore.dispatch({ type: 'NAV_PUSH', url: window.location.pathname + window.location.search });
      
      // Proactively preload primary Bible translation so it's ready before user interacts with search.
      // Bible.loadTranslation deduplicates, so this is safe even if BibleView loads it too.
      // After raw data loads, also initialize bible-reader.js state (buildBookChapterCounts)
      // so navigation to Bible is instant â€” no retry loop needed.
      if (typeof Bible !== 'undefined') {
        const initState = AppStore.getState();
        const preloadTranslation = initState?.content?.params?.translation || Bible.getDefaultTranslation() || 'akjv';
        Bible.loadTranslation(preloadTranslation).then(() => {
          if (typeof switchTranslation === 'function') {
            switchTranslation(preloadTranslation);
          }
        }).catch(() => {});
      }
      
      // Intercept in-app links so they never cause a full page reload (keeps RAM cache)
      document.addEventListener('click', function interceptInAppLinks(e) {
        const a = e.target && e.target.closest ? e.target.closest('a') : null;
        if (!a || !a.href) return;
        // Skip hash-only links (href="#") â€” these are handled by their own onclick handlers
        const rawHref = a.getAttribute('href');
        if (rawHref === '#' || rawHref === '') return;
        try {
          const url = new URL(a.href);
          if (url.origin !== window.location.origin) return;
          if (a.hasAttribute('download') || a.target === '_blank') return;
          const pathname = url.pathname;
          if (/\.(pdf|json|css|js|png|jpg|jpeg|gif|ico|svg|txt|woff2?)(\?|$)/i.test(pathname)) return;
          if (pathname === '/' || pathname.startsWith('/reader') || pathname.startsWith('/calendar') ||
              pathname.startsWith('/bible') || pathname.startsWith('/timeline') ||
              pathname.startsWith('/symbols') || pathname.startsWith('/book') || pathname.startsWith('/settings') ||
              pathname.startsWith('/tutorial') || pathname.startsWith('/help') || pathname.startsWith('/blog') || pathname.startsWith('/feasts') ||
              pathname.startsWith('/priestly') || pathname.startsWith('/sabbath-tester') ||
              /^\/[^/]+\/[^/]+\/\d{4}-\d{2}-\d{2}\//.test(pathname)) {
            e.preventDefault();
            AppStore.dispatch({ type: 'URL_CHANGED', url: url });
            if (window.history.pushState) window.history.pushState({}, '', url.pathname + url.search + (url.hash || ''));
          }
        } catch (err) { /* ignore */ }
      }, true);
      
      // Sync global state for ported modules
      syncGlobalState();
      AppStore.subscribe(syncGlobalState);
      
      // Nav buttons now use browser history directly (history.back/forward)
      // No need to track internal navigation state - browser handles it
      
      console.log('[App] Initialized successfully');
      
      // Register service worker for PWA (skip in Electron â€” all files are local)
      if ('serviceWorker' in navigator && !(window.electronAPI && window.electronAPI.isElectron)) {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('[PWA] Service worker registered:', registration.scope);
          })
          .catch((error) => {
            console.warn('[PWA] Service worker registration failed:', error);
          });
      }
      
      // PWA Install handling (skip in Electron â€” already installed as desktop app)
      if (!(window.electronAPI && window.electronAPI.isElectron)) {
        setupInstallPrompt();
      }
      
      // Hide fixed-position tooltips when scrolling (they don't move with content).
      // On mobile (touch devices), skip â€” user taps to open and scrolls to read.
      window.addEventListener('scroll', () => {
        const isMobile = window.matchMedia('(pointer: coarse)').matches;
        if (!isMobile) {
          document.querySelectorAll('.symbol-tooltip, .word-hover-tooltip, .hebrew-tooltip, .book-ref-popup').forEach(el => el.remove());
        }
      }, { passive: true });
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PWA INSTALL FUNCTIONALITY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let deferredInstallPrompt = null;
    
    function setupInstallPrompt() {
      const installBtn = document.getElementById('install-app-btn');
      
      // Check if already installed as PWA or running in Electron
      if (window.matchMedia('(display-mode: standalone)').matches || 
          window.navigator.standalone === true ||
          (window.electronAPI && window.electronAPI.isElectron)) {
        // Already installed, hide install button
        return;
      }
      
      // Listen for beforeinstallprompt (Chrome, Edge, etc.)
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        if (installBtn) installBtn.style.display = 'flex';
      });
      
      // On iOS, show the button with instructions
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
      if (isIOS && isSafari && installBtn) {
        installBtn.style.display = 'flex';
      }
    }
    
    function handleInstallClick() {
      // Track install button click
      trackInstallClick();
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      if (isIOS) {
        // Show iOS install instructions modal
        showIOSInstallModal();
      } else if (deferredInstallPrompt) {
        // Use the native install prompt
        deferredInstallPrompt.prompt();
        deferredInstallPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('[PWA] User accepted install prompt');
            trackInstallAccepted();
          }
          deferredInstallPrompt = null;
          const installBtn = document.getElementById('install-app-btn');
          if (installBtn) installBtn.style.display = 'none';
        });
      }
      
      // Close sidebar menu
      AppStore.dispatch({type: 'CLOSE_MENU'});
    }
    
    function showIOSInstallModal() {
      const overlay = document.getElementById('ios-install-overlay');
      if (overlay) {
        overlay.classList.add('visible');
      }
    }
    
    function closeIOSInstallModal(event) {
      if (event && event.target !== event.currentTarget) return;
      const overlay = document.getElementById('ios-install-overlay');
      if (overlay) {
        overlay.classList.remove('visible');
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOATCOUNTER ANALYTICS TRACKING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Track book PDF download with GoatCounter
    function trackBookDownload() {
      if (typeof goatcounter !== 'undefined' && goatcounter.count) {
        goatcounter.count({
          path: '/download/book-pdf',
          title: 'Book PDF Download',
          event: true
        });
      }
    }
    
    // Track install app button click
    function trackInstallClick() {
      if (typeof goatcounter !== 'undefined' && goatcounter.count) {
        goatcounter.count({
          path: '/event/install-app-click',
          title: 'Install App Button Click',
          event: true
        });
      }
    }
    
    // Track successful app install
    function trackInstallAccepted() {
      if (typeof goatcounter !== 'undefined' && goatcounter.count) {
        goatcounter.count({
          path: '/event/install-app-accepted',
          title: 'Install App Accepted',
          event: true
        });
      }
    }
    
    // Track physical book purchase click
    function trackBuyBook() {
      if (typeof goatcounter !== 'undefined' && goatcounter.count) {
        goatcounter.count({
          path: '/event/buy-physical-book',
          title: 'Buy Physical Book Click',
          event: true
        });
      }
    }
    
    // Track desktop app download click
    function trackDesktopDownload() {
      if (typeof goatcounter !== 'undefined' && goatcounter.count) {
        goatcounter.count({
          path: '/download/desktop-app',
          title: 'Desktop App Download',
          event: true
        });
      }
    }
  </script>
  
  <!-- Analytics (disabled in Electron desktop app) -->
  <script>
    if (!(window.electronAPI && window.electronAPI.isElectron)) {
      // Google Analytics
      var gaScript = document.createElement('script');
      gaScript.async = true;
      gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-D289E4L6SV';
      document.head.appendChild(gaScript);
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-D289E4L6SV');

      // GoatCounter Analytics
      var gcScript = document.createElement('script');
      gcScript.async = true;
      gcScript.dataset.goatcounter = 'https://lunarsabbath.goatcounter.com/count';
      gcScript.src = '//gc.zgo.at/count.js';
      document.head.appendChild(gcScript);
    }
  </script>
</body>
</html>
