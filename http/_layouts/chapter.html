---
---
<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{page.title}} - {{site.title}}</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="{{ site.title }}" property="og:site_name"/>
    
    {%- if page.title -%}
    <meta content="{{ page.title }}" property="og:title"/>
    <meta content="article" property="og:type"/>
    <meta content="{{ site.url }}{{ page.url }}" property="og:url"/>
    {%- endif -%}

    <meta content="{{page.content | strip_html | strip | escape | truncatewords: 50}}" property="og:description"/> 

    <link rel="canonical" href="{{site.url}}{{page.url}}"/>
    <link rel="icon" href="{{site.favicon}}" type="image/png" sizes="16x16"/>
    <link href="/assets/css/style.css" rel="stylesheet" media="all" class="default"/>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>
    <link href="/assets/css/book.css" rel="stylesheet" media="all"/>
    
    {% seo %}
</head>

<body>
    <div class="container">                    
        <div class="box">
            <button class="header-back-btn" id="header-back-btn" onclick="safeGoBack()" title="Go back" style="display:none;">
                <i class="fa fa-arrow-left"></i>
            </button>
            <script>
                // Only show back button if we came from the same site
                (function() {
                    const btn = document.getElementById('header-back-btn');
                    const referrer = document.referrer;
                    const currentOrigin = window.location.origin;
                    
                    // Show if referrer is from same origin and there's history
                    if (referrer && referrer.startsWith(currentOrigin) && history.length > 1) {
                        btn.style.display = 'flex';
                    }
                })();
                
                function safeGoBack() {
                    const referrer = document.referrer;
                    const currentOrigin = window.location.origin;
                    
                    if (referrer && referrer.startsWith(currentOrigin)) {
                        history.back();
                    } else {
                        // Fallback: go to home
                        window.location.href = '/';
                    }
                }
            </script>
            {%- include header.html -%}
            
            <main class="chapter-content">
                <nav class="chapter-nav">
                    {% if page.previous %}
                    <a href="{{ page.previous.url }}" class="prev-chapter">&larr; {{ page.previous.title | truncatewords: 5 }}</a>
                    {% endif %}
                    <a href="/" class="toc-link">Table of Contents</a>
                    {% if page.next %}
                    <a href="{{ page.next.url }}" class="next-chapter">{{ page.next.title | truncatewords: 5 }} &rarr;</a>
                    {% endif %}
                </nav>

                <article>
                    <h1>{{page.title}}</h1>
                    
                    {% if page.chapter_number %}
                    <p class="chapter-number">Chapter {{ page.chapter_number }}</p>
                    {% endif %}

                    <div class="content chapter-body">
                        {{ content }}
                    </div>
                </article>

                <!-- Related Facts Sidebar -->
                {% if page.related_facts %}
                <aside class="related-facts-sidebar">
                    <h4>Related Facts</h4>
                    <ul>
                    {% for fact_name in page.related_facts %}
                        {% assign fact = site.facts | where: "name", fact_name | first %}
                        {% if fact %}
                        <li>
                            <a href="{{ fact.url }}">{{ fact.title }}</a>
                            <span class="confidence-badge {{ fact.confidence | downcase | replace: ' ', '-' }}">{{ fact.confidence }}</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </aside>
                {% endif %}

                <nav class="chapter-nav bottom">
                    {% if page.previous %}
                    <a href="{{ page.previous.url }}" class="prev-chapter">&larr; Previous</a>
                    {% endif %}
                    <a href="/" class="toc-link">Table of Contents</a>
                    {% if page.next %}
                    <a href="{{ page.next.url }}" class="next-chapter">Next &rarr;</a>
                    {% endif %}
                </nav>
            </main>

            <hr/>
            {%- include footer.html -%}
        </div>
        <button class="scroll-to-top" id="scroll-to-top"><i class="fa fa-chevron-up"></i></button>
    </div>
    
    <script>
        document.getElementById("scroll-to-top").addEventListener("click", function() {
            window.scrollTo({top: 0, left: 0, behavior: 'smooth'});
        });
        
        // Add anchor IDs and links to scripture citations in blockquotes
        document.querySelectorAll('blockquote').forEach(function(bq) {
            // Look for citation pattern like "— Book Chapter:Verse" or "— Book Chapter:Verse-Verse"
            const text = bq.textContent;
            const match = text.match(/—\s*([\d\s]*[A-Za-z]+(?:\s+[A-Za-z]+)*)\s+(\d+):(\d+)(?:-(\d+))?/);
            if (match) {
                const book = match[1].trim();
                const chapter = match[2];
                const startVerse = match[3];
                const endVerse = match[4] || startVerse;
                
                // Create anchor ID
                const anchorId = 'ref-' + book.toLowerCase().replace(/\s+/g, '') + '-' + chapter + '-' + startVerse;
                bq.id = anchorId;
                
                // Find and linkify the citation in the blockquote
                const citationPattern = new RegExp('(—\\s*)(' + book.replace(/\s+/g, '\\s+') + '\\s+' + chapter + ':' + startVerse + (match[4] ? '-' + endVerse : '') + ')');
                
                // Walk through text nodes to find and wrap the citation
                const walker = document.createTreeWalker(bq, NodeFilter.SHOW_TEXT, null, false);
                let node;
                while (node = walker.nextNode()) {
                    if (citationPattern.test(node.textContent)) {
                        const span = document.createElement('span');
                        span.innerHTML = node.textContent.replace(citationPattern, function(match, prefix, ref) {
                            const encodedBook = encodeURIComponent(book);
                            const url = '/bible/kjv/' + encodedBook + '/' + chapter + '?verse=' + startVerse;
                            return prefix + '<a href="' + url + '" class="scripture-link" title="Open in Bible Reader">' + ref + '</a>';
                        });
                        node.parentNode.replaceChild(span, node);
                        break;
                    }
                }
            }
        });
        
        // Also linkify inline scripture references in regular text (e.g., "see Genesis 1:14")
        const scripturePattern = /\b(Genesis|Exodus|Leviticus|Numbers|Deuteronomy|Joshua|Judges|Ruth|1\s*Samuel|2\s*Samuel|1\s*Kings|2\s*Kings|1\s*Chronicles|2\s*Chronicles|Ezra|Nehemiah|Esther|Job|Psalms?|Proverbs|Ecclesiastes|Song\s*of\s*Solomon|Isaiah|Jeremiah|Lamentations|Ezekiel|Daniel|Hosea|Joel|Amos|Obadiah|Jonah|Micah|Nahum|Habakkuk|Zephaniah|Haggai|Zechariah|Malachi|Matthew|Mark|Luke|John|Acts|Romans|1\s*Corinthians|2\s*Corinthians|Galatians|Ephesians|Philippians|Colossians|1\s*Thessalonians|2\s*Thessalonians|1\s*Timothy|2\s*Timothy|Titus|Philemon|Hebrews|James|1\s*Peter|2\s*Peter|1\s*John|2\s*John|3\s*John|Jude|Revelation)\s+(\d+):(\d+)(?:-(\d+))?/g;
        
        document.querySelectorAll('.chapter-body p, .chapter-body li').forEach(function(el) {
            // Skip if inside a blockquote (already handled) or already contains links
            if (el.closest('blockquote')) return;
            
            const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            let node;
            while (node = walker.nextNode()) {
                if (scripturePattern.test(node.textContent)) {
                    textNodes.push(node);
                }
                scripturePattern.lastIndex = 0; // Reset regex
            }
            
            textNodes.forEach(function(textNode) {
                const span = document.createElement('span');
                span.innerHTML = textNode.textContent.replace(scripturePattern, function(match, book, chapter, startVerse, endVerse) {
                    const encodedBook = encodeURIComponent(book.replace(/\s+/g, ' '));
                    const url = '/bible/kjv/' + encodedBook + '/' + chapter + '?verse=' + startVerse;
                    return '<a href="' + url + '" class="scripture-link" title="Open in Bible Reader">' + match + '</a>';
                });
                textNode.parentNode.replaceChild(span, textNode);
            });
        });
        
        // Highlight target if URL has hash
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                target.classList.add('scripture-highlight');
                setTimeout(function() {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }
    </script>
    {%- include contextmenu.html -%}
    {%- include analytics.html -%}
</body>
</html>
